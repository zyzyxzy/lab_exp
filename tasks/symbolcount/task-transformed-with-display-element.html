<!DOCTYPE html>
<html>

<head>
    <title>Anthrope</title>
    <script src="../../libraries/jquery-3.5.1.min.js"></script>
    <script src="../../jspsych/jspsych.js"></script>
    <script src="../../jspsych/plugins/jspsych-html-slider-response.js"></script>
    <script src="../../jspsych/plugins/jspsych-external-html.js"></script>
    <script src="../../jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="../../jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="../../jspsych/plugins/jspsych-instructions.js"></script>
    <script src="../../jspsych/plugins/jspsych-html-button-response.js"></script>
    <script src="../../jspsych/plugins/jspsych-survey-text-dropdown.js"></script>
    <script src="../../jspsych/plugins/jspsych-survey-text.js"></script>
    <link href="../../jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <!-- load task javascript -->
    <script src="../../tasks/symbolcount/task.js"></script>
    <!-- our helper functions  -->
    <script type="text/javascript" src="../../libraries/utils.js"></script>


</head>

<body>
      <!-- Change 3: Adding extra scripts for Qualtrics -->  
  <!-- jspsych.css should be availble from your GitHub at 
    https://<your-github-username>.github.io/<your-experiment-name>/jspsych-6.1.0/css/jspsych.css -->
    
  <div>
    <span style="font-size: 24px;">
      <br><br>
      If you are seeing this message for <span style="color: rgb(255, 0, 0);"><b>more than 5 minutes</b></span>,<br>
      please screen-capture this screen and send the image to us.
      <br><br>
      <span style="font-size: 28px;">We are very sorry for the inconvenience.</span>
    </span>
  </div>

  <!-- Change 2: Adding `display_stage` CSS and Div -->
  <style>
    #display_stage_background {
      width: 100vw;
      background-color: white;
      z-index: -1;
    }

    #display_stage {
      position: fixed;
      left: 1vw;
      top: 1vh;
      height: 98vh;
      width: 98vw;
      background-color: white;
      box-shadow: 1px 1px 1px #999;
      border-radius: 15px;
      z-index: 0;
      overflow-y: hidden;
      overflow-x: hidden;
    }
  </style>
  <!-- COPY PASTE TO QUALTRICS UP TO HERE -->

  <div id='display_stage_background'></div>
  <div id='display_stage'></div>

</body>

<script>
  /* start the experiment */
  jsPsych.init({
    timeline: timeline,
    /* Change 1: Using `display_element` */
    display_element: 'display_stage',
    on_finish: function () {
      jsPsych.data.displayData();
    }
  });
  
  jsPsych.init({
    timeline: timeline,
    display_element: 'display_stage',
    on_finish: function () {
        document.body.style.backgroundColor = 'white';
        var datasummary = create_datasummary();

        jsPsych.data.get().addToAll({ // add parameters to all trials
            total_time: jsPsych.totalTime() / 60000,
        });
        jsPsych.data.get().first(1).addToAll({
            info_: info_,
            datasummary: datasummary,
        });
        if (debug) {
            jsPsych.data.displayData();
        }

        info_.tasks_completed.push(taskinfo.uniquestudyid);
        info_.current_task_completed = 1;
        localStorage.setObj('info_', info_);
        submit_data(jsPsych.data.get().json(), taskinfo.redirect_url);
    }
});

// remove trials with too fast/slow RT
function preprocess_symbolcount() {  // 
    var data_sub = jsPsych.data.get().filter({ "event": "feedback" });  // select feedback trials
    var data_sub = data_sub.filterCustom(function (trial) { return trial.rt > 100 });
    var cutoffs = mad_cutoffs(data_sub.select('rt').values);
    data_sub = data_sub.filterCustom(function (trial) { return trial.rt > cutoffs[0] }).filterCustom(function (trial) { return trial.rt < cutoffs[1] });
    return data_sub;
}

function create_datasummary() {
    var d = preprocess_symbolcount(); // preprocess/clean data

    var acc = d.select('acc').mean();

    if (acc === undefined) {
        acc = null;
    }

    // store above info in array
    var datasummary = [
        { param: "acc", value: acc },
    ];

    // add id/country information
    datasummary.forEach(function (s) {
        s.subject = info_.subject;
        s.time = info_.time;
        s.country_code = info_.demographics.country_code;
        s.country = info_.demographics.country;
        s.total_time = jsPsych.totalTime() / 60000;
    })

    return datasummary
}
</script>
</body>

</html>